(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["plugins/community/activity/activity"],{1769:function(t,i,e){},"256d":function(t,i,e){"use strict";e.r(i);var a=e("f43f"),n=e.n(a);for(var o in a)"default"!==o&&function(t){e.d(i,t,function(){return a[t]})}(o);i["default"]=n.a},"49e3":function(t,i,e){"use strict";var a=function(){var t=this,i=t.$createElement;t._self._c;t._isMounted||(t.e0=function(i){t.inputRemark=!1},t.e1=function(i){t.inputRemark=!0},t.e2=function(i){t.recommendDialog=!t.recommendDialog},t.e3=function(i){t.recommendDialog=!t.recommendDialog})},n=[];e.d(i,"a",function(){return a}),e.d(i,"b",function(){return n})},"83e9":function(t,i,e){"use strict";var a=e("1769"),n=e.n(a);n.a},a3e4:function(t,i,e){"use strict";e.r(i);var a=e("49e3"),n=e("256d");for(var o in n)"default"!==o&&function(t){e.d(i,t,function(){return n[t]})}(o);e("83e9");var s=e("2877"),r=Object(s["a"])(n["default"],a["a"],a["b"],!1,null,"010b6097",null);i["default"]=r.exports},f43f:function(t,i,e){"use strict";(function(t){Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var a=e("2f62");function n(t,i){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);i&&(a=a.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),e.push.apply(e,a)}return e}function o(t){for(var i=1;i<arguments.length;i++){var e=null!=arguments[i]?arguments[i]:{};i%2?n(e,!0).forEach(function(i){s(t,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):n(e).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))})}return t}function s(t,i,e){return i in t?Object.defineProperty(t,i,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[i]=e,t}var r=function(){return e.e("plugins/community/components/app-head").then(e.bind(null,"d0d3"))},d=function(){return e.e("components/page-component/app-share-qr-code-poster/app-share-qr-code-poster").then(e.bind(null,"409e"))},c=function(){return Promise.all([e.e("common/vendor"),e.e("components/page-component/goods/u-attr")]).then(e.bind(null,"b4bc"))},l=function(){return e.e("components/basic-component/app-close/app-close").then(e.bind(null,"f0dd"))},u={data:function(){return{activeIndex:0,nav_list:[],cat_id:-1,id:null,showCart:!1,is_loading:!1,submitLock:!1,recommendDialog:!1,showShare:!1,stopLoad:!1,showOther:!1,more:!1,is_middleman:!1,share:!1,default:!1,inputRemark:!0,cartLength:0,windowHeight:0,is_exist:0,page:1,poster:"",mobile:"",remark:"",d:"",h:"",m:"",s:"",selectAttr:{},animationData:{},animation:{},attr_price:"0.00",number:1,space:"0m",display:"none",attrShow:!1,scrollTop:0,scrollHeight:0,goods:null,timeInterval:null,buyBool:!0,longitude:"",latitude:"",activity:{rate:0},middleman:{},setting:{},recommend:{},list:[],cart:[],user_list:[],template_message_list:[],end_time:"1小时前",title:"",total:"0.00",minus:"0.00",middleman_id:0,first:!0,showClose:!1,is_open:!1,disable:"disable"}},components:{appShareQrCode:d,appHead:r,uAttr:c,AppClose:l},computed:o({},(0,a.mapGetters)("mallConfig",{getTheme:"getTheme"}),{},(0,a.mapState)({community:function(t){return t.mallConfig.__wxapp_img.community},bonusImg:function(t){return t.mallConfig.__wxapp_img.bonus},appImg:function(t){return t.mallConfig.__wxapp_img.mall},appSetting:function(t){return t.mallConfig.mall.setting},userInfo:function(t){return t.user.info}})),onLoad:function(i){var e=this;this.$commonLoad.onload(i);var a=this;i.activity_id&&(this.id=i.activity_id),i.id&&(this.id=i.id),this.title=i.title,t.setNavigationBarTitle({title:i.title}),t.getSystemInfo({success:function(t){a.windowHeight=t.windowHeight}}),t.getLocation({success:function(n){if(t.hideLoading(),a.longitude=n.longitude,a.latitude=n.latitude,e.$storage.getStorageSync("middleman_info")){var o=e.$storage.getStorageSync("middleman_info");o.id>0&&(i.middleman_id?(a.middleman_id=i.middleman_id,a.share=!0):a.middleman_id=o.user_id)}else i.middleman_id&&(a.middleman_id=i.middleman_id,a.share=!0);a.$showLoading({type:"global",text:"加载中..."}),a.getSetting()},fail:function(){t.hideLoading(),t.showModal({title:"提示",content:"获取位置信息失败，需要授权获取您的位置信息",showCancel:!1,confirmText:"打开授权",success:function(i){i.confirm&&t.openSetting({})}})}}),wx.showShareMenu({menus:["shareAppMessage","shareTimeline"]})},onUnload:function(){this.stopLoad=!0,clearInterval(this.timeInterval)},onHide:function(){this.stopLoad=!0,clearInterval(this.timeInterval)},onShow:function(){var t=this;if(this.stopLoad)if(this.stopLoad=!1,this.$storage.getStorageSync("bind")){var i=this.$storage.getStorageSync("bind");if(i>0){if(t.$showLoading({type:"global",text:"加载中..."}),t.middleman={},t.middleman_id=0,this.$storage.getStorageSync("middleman_info")){var e=this.$storage.getStorageSync("middleman_info");e.id>0&&(t.middleman_id=e.user_id),t.getActivity("reload")}else t.getActivity("reload");this.$storage.removeStorageSync("bind")}else t.getActivity("reload")}else t.id>0&&t.getActivity()},onShareAppMessage:function(){return this.hShareAppMessage()},methods:{hShareAppMessage:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.$shareAppMessage({title:this.setting.app_share_title?this.setting.app_share_title:this.title,imageUrl:this.setting.app_share_pic?this.setting.app_share_pic:this.list[0].cover_pic,path:"/plugins/community/activity/activity",params:{id:this.id,user_id:this.userInfo.options.user_id,middleman_id:this.middleman.user_id}},t)},changeStatus:function(i,e){this.cat_id=i,this.page=1,this.activeIndex=e<2?0:e-2,t.showLoading({mask:!0,title:"加载中"}),this.getList(this.middleman.user_id)},requestCats:function(t){var i=this;this.$request({url:this.$api.community.cats,data:{id:this.id,middleman_id:t||this.middleman.user_id}}).then(function(e){0===e.code&&(i.nav_list=e.data.list,i.getList(t))})},toSubmit:function(){var t=this;this.showClose=!1,setTimeout(function(){t.showClose=!0})},getMall:function(t){this.is_open=1==t.is_open,this.is_open&&this.allBuy()},scroll:function(t){this.scrollHeight=t.detail.scrollTop},getMore:function(){this.more&&(this.page++,t.showLoading({mask:!0,title:"加载更多"}),this.getOther(),this.more=!1)},getOther:function(){var i=this,e={id:i.id,middleman_id:i.middleman.user_id,page:i.page};i.cat_id>0&&(e.cat_id=i.cat_id),i.$request({url:i.$api.community.activity_goods,data:e}).then(function(e){t.hideLoading(),i.$hideLoading(),0===e.code&&(20===e.data.list.length&&(i.more=!0),i.list=i.list.concat(e.data.list))})},openCart:function(){this.showCart=!this.showCart,this.stopLoad=!0,0==this.showCart&&(this.stopLoad=!1,this.getActivity())},toList:function(){if("0"===this.middleman.is_allow_change)return!1;t.navigateTo({url:"/plugins/community/captain/captain?longitude="+this.longitude+"&latitude="+this.latitude})},showHiddenClick:function(){this.showShare=!this.showShare},toGoods:function(i){this.stopLoad=!0,t.navigateTo({url:"/plugins/community/goods/goods?goods_id="+i.id+"&middleman_id="+this.middleman.user_id})},toIndex:function(){this.stopLoad=!0,t.navigateTo({url:"/plugins/community/index/index"})},toOrder:function(){this.stopLoad=!0,t.navigateTo({url:"/plugins/community/order/order?is_user=1"})},toUser:function(){this.stopLoad=!0,t.navigateTo({url:"/pages/user-center/user-center"})},toActivity:function(){this.stopLoad=!0,t.redirectTo({url:"/plugins/community/activity/activity?id="+this.recommend.activity_id})},attr:function(t){this.selectAttr=t.item,this.number=t.number,this.attr_price=(+this.selectAttr.price*+this.number).toFixed(2)},imgLoad:function(){this.is_loading=!0},allBuy:function(){var i=this;return!this.submitLock&&(this.showCart=!1,this.scrollTop=this.scrollHeight,this.default?(this.$nextTick().then(function(){i.scrollTop=9999999,i.default=!1}),t.showToast({title:"请确认手机号",icon:"none",duration:1e3}),!1):void(11==this.mobile.length&&/0?(1)[0-9]{10}/.test(this.mobile)?this.$subscribe(this.template_message_list).then(function(t){i.submit()}).catch(function(){i.submit()}):(this.$nextTick().then(function(){i.scrollTop=9999999}),this.stopLoad=!1,this.getActivity(),t.showToast({title:"请输入正确的手机号码",icon:"none",duration:1e3}))))},submit:function(){var i=this;t.showLoading({mask:!0,title:"提交订单..."}),this.stopLoad=!0,this.submitLock=!0;var e=[];for(var a in this.cart)if(1==this.cart[a].is_exist){var n={};n.id=this.cart[a].goods_id,n.goods_attr_id=this.cart[a].goods_attr_id,n.num=this.cart[a].num,n.cart_id=this.cart[a].id,n.attr=this.cart[a].attr_list,n.cat_id=0,n.form_data=[],e.push(n)}if(0===e.length)return t.showToast({title:"请添加有效商品",icon:"none",duration:1e3}),!1;var o=[{mch_id:0,activity_id:this.id,middleman_id:this.middleman.user_id,goods_list:e,distance:0,remark:this.remark,order_form:[],use_integral:0,user_coupon_id:0}],s={};s.list=o,s.address_id=0,s.address={name:this.userInfo.nickname,mobile:this.mobile},this.$request({url:this.$api.community.order_submit,data:{form_data:JSON.stringify(s)},method:"post"}).then(function(e){0===e.code?i.getPayOrderId(e.data.queue_id,e.data.token):(i.submitLock=!1,i.stopLoad=!1,t.hideLoading(),t.showModal({title:"提示",content:e.msg,showCancel:!1}))}).catch(function(e){i.submitLock=!1,i.stopLoad=!1,t.hideLoading(),t.showModal({title:"提示",content:e.errMsg,showCancel:!1})})},getPayOrderId:function(i,e){var a=this;this.$request({url:this.$api.order.pay_data,method:"post",data:{queue_id:i,token:e}}).then(function(n){0===n.code?n.data.retry&&1===n.data.retry?a.getPayDataTimer=setTimeout(function(){a.getPayOrderId(i,e)},1e3):(t.hideLoading(),a.cart=[],a.pay(n.data)):(a.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:n.msg,showCancel:!1}))}).catch(function(i){a.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:i.errMsg,showCancel:!1})})},pay:function(i){var e=this;this.$storage.removeStorageSync("middleman_info"),this.$payment.pay(i.id).then(function(){e.submitLock=!1;var a="/plugins/community/order/order";t.navigateTo({url:"/pages/order-submit/pay-result?payment_order_union_id=".concat(i.id,"&order_page_url=").concat(a)})}).catch(function(){e.submitLock=!1,e.toOrder()})},_calcValue:function(t,i){"minus"===i?this.cart[t].num--:"plus"===i&&this.cart[t].num++,this._onBlur(t)},_onBlur:function(t){for(var i in this.total=0,this.cartLength=0,this.cart)this.total=+this.total+ +this.cart[i].price*this.cart[i].num,this.cartLength+=+this.cart[i].num;var e=0;for(var a in this.activity.full_price)(+this.activity.full_price[a].full_price<+this.total||+this.activity.full_price[a].full_price==+this.total)&&this.activity.full_price[a].reduce_price>e&&(e=+this.activity.full_price[a].reduce_price);this.total=(+this.total-e).toFixed(2),this.minus=e.toFixed(2),0==this.cart[t].num?this.delCart(t):this.$request({url:this.$api.community.cart_edit,data:{list:JSON.stringify(this.cart)}})},clearAll:function(){var t=this,i=[];for(var e in this.cart)i.push(this.cart[e].id);this.cart=[],this.showCart=!1,this.$request({url:this.$api.community.cart_delete,data:{cart_id_list:JSON.stringify(i)}}).then(function(){t.stopLoad=!1,t.getActivity()})},delCart:function(i){var e=this,a=[];for(var n in a.push(this.cart[i].id),this.cart.splice(i,1),this.total=0,this.cartLength=0,this.cart)this.total=+this.total+ +this.cart[n].price*this.cart[n].num,this.cartLength+=+this.cart[n].num;var o=0;for(var s in this.activity.full_price)(+this.activity.full_price[s].full_price<+this.total||+this.activity.full_price[s].full_price==+this.total)&&this.activity.full_price[s].reduce_price>o&&(o=+this.activity.full_price[s].reduce_price);this.total=(+this.total-o).toFixed(2),this.minus=o.toFixed(2),0===this.cart.length&&(this.showCart=!1),this.$request({url:this.$api.community.cart_delete,data:{cart_id_list:a}}).then(function(){e.stopLoad=!1,e.getActivity()}).catch(function(){e.attrShow=!1,t.hideLoading()})},add:function(){var i=this;t.showLoading({mask:!0,title:"加入购物车"});var e={activity_id:this.id,goods_id:this.selectAttr.goods_id,goods_attr_id:this.selectAttr.id,num:this.number};this.$request({url:this.$api.community.cart_add,data:e,method:"post"}).then(function(e){0===e.code?i.addResult(e.data.queue_id,e.data.token):(t.hideLoading(),i.attrShow=!1,t.showToast({title:e.msg,icon:"none",duration:1e3}))}).catch(function(){i.attrShow=!1,t.hideLoading()})},addResult:function(i,e){var a=this;this.$request({url:this.$api.community.cart_result,method:"post",data:{queue_id:i,token:e}}).then(function(n){if(0===n.code)if(n.data&&1===n.data.retry)a.getResult=setTimeout(function(){a.addResult(i,e)},1e3);else{a.attrShow=!1;var o=-1;for(var s in a.cart)a.cart[s].goods_id==a.selectAttr.goods_id&&a.cart[s].goods_attr_id==a.selectAttr.id&&(o=s);if(o>-1)a.cart[o].num+=+a.number;else{var r={activity_id:a.id,community_goods_id:a.goods.id,goods_id:a.selectAttr.goods_id,goods_attr_id:a.selectAttr.id,num:a.number,name:a.goods.name,attr_list:a.selectAttr.attr_list,pic_url:a.selectAttr.pic_url,id:0,price:a.selectAttr.price,is_exist:1};a.cart.push(r)}a.total=0,a.cartLength=0;var d=!0,c=!1,l=void 0;try{for(var u,h=a.cart[Symbol.iterator]();!(d=(u=h.next()).done);d=!0){var m=u.value;a.total=+a.total+ +m.price*m.num,a.cartLength+=+m.num}}catch(p){c=!0,l=p}finally{try{d||null==h.return||h.return()}finally{if(c)throw l}}var g=0;for(var f in a.activity.full_price)(+a.activity.full_price[f].full_price<+a.total||+a.activity.full_price[f].full_price==+a.total)&&a.activity.full_price[f].reduce_price>g&&(g=+a.activity.full_price[f].reduce_price);a.total=(+a.total-g).toFixed(2),a.minus=g.toFixed(2),t.hideLoading(),setTimeout(function(){a.goods=null})}else t.hideLoading(),t.showModal({title:"提示",content:n.msg,showCancel:!1})}).catch(function(i){a.attrShow=!1,t.hideLoading(),t.showModal({title:"提示",content:i.errMsg,showCancel:!1})})},toBuy:function(t){t.buy_goods_auth?(this.selectAttr=null,this.goods=t,this.attrShow=!0):this.$tips.showToast({title:"您暂无权限购买该商品",icon:"none"})},getCart:function(){var i=this;if(i.stopLoad)return!1;i.$request({url:i.$api.community.cart,data:{middleman_id:i.middleman.user_id,activity_id:i.activity.id}}).then(function(e){if(i.stopLoad)return!1;if(0===e.code){for(var a in i.total=0,i.cartLength=0,i.cart=e.data.list,i.is_exist=0,i.cart)0==i.cart[a].is_exist&&i.is_exist++,i.total=+i.total+ +i.cart[a].price*i.cart[a].num,i.cartLength+=+i.cart[a].num;var n=0;for(var o in i.activity.full_price)(+i.activity.full_price[o].full_price<+i.total||+i.activity.full_price[o].full_price==+i.total)&&i.activity.full_price[o].reduce_price>n&&(n=+i.activity.full_price[o].reduce_price);i.total=(+i.total-n).toFixed(2),i.minus=n.toFixed(2)}else i.stopLoad=!0,t.showToast({title:e.msg,icon:"none",duration:1e3}),"所选活动已下架"===e.msg&&setTimeout(function(){t.navigateBack({})},1e3)}).catch(function(){i.$hideLoading()})},getTime:function(t){t>86399?(this.d=Math.floor(t/86400),t-=86400*this.d):this.d=0,t>3599?(this.h=Math.floor(t/3600),this.h<10&&(this.h="0"+this.h),t-=3600*this.h):this.h="00",t>59?(this.m=Math.floor(t/60),this.m<10&&(this.m="0"+this.m),t-=60*this.m):this.m="00",t<60&&(this.s=t,this.s<10&&(this.s="0"+this.s))},getSetting:function(){var i=this;i.$request({url:i.$api.community.setting}).then(function(e){if(0===e.code){switch(i.head=i.community.a,i.getTheme.key){case"b":i.head=i.community.b;break;case"c":i.head=i.community.c;break;case"d":i.head=i.community.d;break;case"e":i.head=i.community.e;break;case"g":i.head=i.community.g;break;case"h":i.head=i.community.h;break;case"i":i.head=i.community.i;break}i.setting=e.data,i.getActivity()}else i.$hideLoading(),t.showToast({title:e.msg,icon:"none",duration:1e3})}).catch(function(){i.$hideLoading()})},getList:function(i){var e=this,a={type:1,id:e.id};a.middleman_id=i||e.middleman.user_id,e.cat_id>0&&(a.cat_id=e.cat_id),e.$request({url:e.$api.community.activity_goods,data:a}).then(function(i){if(t.hideLoading(),e.$hideLoading(),0===i.data.list.length)return e.page=1,e.stopLoad=!0,t.showToast({title:"活动商品异常，正在返回活动主页",icon:"none",duration:1e3}),setTimeout(function(){t.redirectTo({url:"/plugins/community/list/list"})},1e3),!1;e.list=i.data.list,i.data.list.length<20?e.more=!1:e.more=!0})},getActivity:function(i){var e=this,a=this,n={id:a.id,longitude:a.longitude,latitude:a.latitude};a.middleman_id>0&&(n.middleman_id=a.middleman_id),a.$request({url:a.$api.community.user_activity,data:n}).then(function(n){if(0===n.code){if(0!=a.nav_list.length&&"reload"!=i||a.requestCats(n.data.middleman_info.user_id),!a.mobile&&n.data.last_mobile&&(a.mobile=n.data.last_mobile,a.default=!0),a.activity=n.data.activity,a.is_middleman=n.data.is_middleman,a.middleman=n.data.middleman_info,0==a.middleman_id&&e.$storage.getStorageSync("middleman_info")){var o=e.$storage.getStorageSync("middleman_info");o.id>0&&(a.middleman=o)}if(a.space=~~a.middleman.distance+"m",a.middleman.distance>1e3&&(a.space=(a.middleman.distance/1e3).toFixed(1)+"km"),a.share&&e.$storage.setStorageSync("middleman_info",a.middleman),a.user_list=n.data.user_list,a.user_list.length>a.activity.user_num&&(a.user_list=a.user_list.slice(0,a.activity.user_num)),a.template_message_list=n.data.template_message_list,1==a.activity.activity_status){a.stopLoad||setTimeout(function(){a.getActivity()},8e3),a.getCart();var s=Math.floor(a.user_list[a.user_list.length-1].time/60);a.end_time=s>60?"1小时前":0==s?"刚刚":s+"分钟前"}if(2==a.activity.activity_status&&n.data.recommend_activity.activity_id>0&&setTimeout(function(){a.recommend=n.data.recommend_activity,a.recommendDialog=!0;var i=t.createAnimation({duration:1e3,timingFunction:"ease"});a.animation=i,setTimeout(function(){i.bottom(0).step(),a.animationData=i.export(),setTimeout(function(){a.showOther=!0},1500)},200)},800),a.activity.time>0){var r=a.activity.time;a.timeInterval=setInterval(function(){a.getTime(r),r--,0==r&&(clearInterval(a.timeInterval),a.getActivity())},1e3)}}else a.stopLoad=!0,"周边没有活动可参加"===n.msg?(t.showToast({title:"周边没有活动可参加，正在返回活动主页",icon:"none",duration:1e3}),setTimeout(function(){t.redirectTo({url:"/plugins/community/list/list"})},1e3)):t.showToast({title:n.msg,icon:"none",duration:1e3})}).catch(function(){t.hideLoading(),a.$hideLoading()})}},onShareTimeline:function(){return this.$shareTimeline({title:this.share_title?this.share_title:this.title,query:{id:this.id,user_id:this.userInfo.options.user_id,middleman_id:this.middleman.user_id}})}};i.default=u}).call(this,e("543d")["default"])}},[["0166","common/runtime","common/vendor"]]]);